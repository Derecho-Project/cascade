<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cascade: The Cascade Service</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Cascade
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">The Cascade Service </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md45"></a> The Cascade Service is a configurable K/V store with fast RDMA data paths. Cascade service is the easier one of the two approaches using Cascade because the application access the service through two simple APIs: <a href="https://github.com/Derecho-Project/cascade/blob/master/include/cascade/service_client_api.hpp"><code>service_client_api.hpp</code></a> and <a href="https://github.com/Derecho-Project/cascade/blob/master/include/cascade/service_server_api.hpp"><code>service_server_api</code></a> instead of using the more complicated native <a class="el" href="namespaceDerecho.html">Derecho</a> API. However, to learn how to use Cascade service, we still need to remind the group, subgroup, shard, and node concepts deriving from <a class="el" href="namespaceDerecho.html">Derecho</a>. Curious users can read our <a href="http://www.cs.cornell.edu/ken/derecho-tocs.pdf">paper</a> for details on <a class="el" href="namespaceDerecho.html">Derecho</a>.</p>
<p>The cascade service is composed of a set of distributed processes talking to each other through RDMA data paths. We call each of the processes a <code>node</code>. Each <code>node</code> is identified by an integer ID. All nodes in the cascade service form a top-level <code>group</code>. The nodes doing the same job specified by a C++ Type are grouped into a <code>Subgroup</code>. Please note that we allow the C++ Subgroup Type to be reused for multiple subgroups if the logic in different subgroups is the same. One subgroup may do a huge work like managing a database table with billions of lines. In such a case, the nodes in a subgroup can be partitioned into <code>shards</code>, each of which takes care of a manageable part of the table. Inside a shard, the nodes are replicas.</p>
<p>The cascade service comes with four pre-defined subgroup types: <code>VCSU</code>, <code>VCSS</code>, <code>PCSU</code>, and <code>PCSS</code>, where V for Volatile, P for Persistent, S for 'Store', and the last character is for the key type of the object ('U' for uint64_t and 'S' for std::string). Please refer to <a href="https://github.com/Derecho-Project/cascade/blob/master/include/cascade/service_types.hpp"><code>service_types.hpp</code></a> for details of those types. All four subgroup types expose a K/V API (see <a href="https://github.com/Derecho-Project/cascade/blob/master/include/cascade/cascade.hpp">ICascadeStore</a>). The persistent types support versioned and timestamped queries.</p>
<p>Once the cascade service is configured and started, the application can store and retrieve the data using the client API defined in <a href="https://github.com/Derecho-Project/cascade/blob/master/include/cascade/service_client_api.hpp"><code>service_client_api.hpp</code></a>. Core to the client API is an <code>external client</code> talking to the Cascade services with an efficient RDMA data path. Please check <a href="https://github.com/Derecho-Project/cascade/blob/master/src/service/client.cpp"><code>client.cpp</code></a> for how to use the client API.</p>
<p>Cascade service allows the application to insert logic on the data path, named as User Defined Logic or <em>UDL</em>. In order for that, the application needs to implement the cascade server API defined in <a href="https://github.com/Derecho-Project/cascade/blob/master/include/cascade/user_defined_logic_interface.hpp"><code>user_defined_logic_interface.hpp</code></a>. We provide examples in <a href="https://github.com/Derecho-Project/cascade/tree/master/src/applications/tests/user_defined_logic">applications/tests/user_defined_logic</a>, showing how to create the <em>UDL</em> dynamic library files. To load the <em>UDL</em> dynamic libraries, the application needs to list the <em>UDL</em> .so files line by line in <code>udl_dlls.cfg</code> located in the current working directory of the server binary. Here is an example for the <code>udl_dlls.cfg</code>. </p><div class="fragment"><div class="line">dll_folder_1/udl_a.so</div>
<div class="line">dll_folder_2/udl_b.so</div>
<div class="line">dll_folder_2/udl_C.so</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md46"></a>
Configuring Cascade Service</h1>
<p>Cascade derives <a class="el" href="namespaceDerecho.html">Derecho</a>'s configuration file. Besides the derecho configurations, Cascade added a section called <code>[CASCADE]</code> in the same file to configure the Cascade service. There are only two options in this section: <code>ondata_library</code> and <code>group_layout</code>. <code>ondata_library</code> specifies the dynamic library containing the server APIs implementation. <code>group_layout</code> specifies the group, subgroup, and shard layout of the cascade service. Please read the comments below for how to describe a layout.</p>
<div class="fragment"><div class="line">[CASCADE]</div>
<div class="line"># Specify group layout here. The layout specifies the following items:</div>
<div class="line"># - How many subgroups of corresponding type (see note below) to create?</div>
<div class="line"># - For each subgroup, how many shards to create?</div>
<div class="line"># - For each shard, what are the minimum number of nodes required(min_nodes_by_shard, defaulted to 1), the maximum</div>
<div class="line">#   number of nodes allowed(max_nodes_by_shard, defaulted to 1), the delivery mode(delivery_modes_by_shard, either</div>
<div class="line">#   &quot;Ordered&quot; or &quot;Raw&quot;, defaulted to &quot;Ordered&quot;), and the profile name(profiles_by_shard, defaulted to &quot;DEFAULT&quot;)</div>
<div class="line"># Derecho parameters in &quot;[SUBGROUP/&lt;profile&gt;]&quot; will be used for the corresponding shard.</div>
<div class="line"># </div>
<div class="line"># The setup is defined in a json array, where each element is a dictionary specifying the layout for a corresponding</div>
<div class="line"># subgroup type. OK, I mentioned &quot;corresponding subgroup type&quot; again and here is the mapping between the configuration</div>
<div class="line"># elements and types used to define a Cascade service --- in the cascade service server code, we started a derecho</div>
<div class="line"># group with a list of types, which currently given as &quot;VCSU,VCSS,PCSU,PCSS&quot;; each of the type in the list CORRESPONDS</div>
<div class="line"># to an entry in the layout json array defined here, following the order in the type list. Therefore, with the current</div>
<div class="line"># type list setup, the layout has four elements with the 1st for type VCSU, the 2nd for VCSS, the 3rd for PCSU, and the</div>
<div class="line"># 4th for PCSS. You can define more elements than types, but the rest are ignored without side effect.</div>
<div class="line"># </div>
<div class="line"># Each dictionary element has two keys: &quot;type_alias&quot; and &quot;layout&quot;. The &quot;type_alias&quot; specifies the human-readable name</div>
<div class="line"># (string) for the corresponding (sigh...the first stressless &quot;corresponding&quot;) type. The &quot;layout&quot; define, with a json </div>
<div class="line"># array, the setup of subgroups of this type. Each element (a layout dict) for a subgroup. Each layout dict has four</div>
<div class="line"># entries corresponding to the above four items. The value for each entry is an array whose length is equal to the</div>
<div class="line"># number of shards. Each element in that array is a setting for the corresponding shard.</div>
<div class="line"># For example, the following configuration defined two subgroups of VCSU type. The first subgroup has one shard and the</div>
<div class="line"># second subgroup has three shards</div>
<div class="line">#</div>
<div class="line"># group_layout = &#39;</div>
<div class="line"># [</div>
<div class="line">#     {</div>
<div class="line">#         &quot;type_alias&quot;:  &quot;VCSU&quot;,</div>
<div class="line">#         &quot;layout&quot;:     [</div>
<div class="line">#                           {</div>
<div class="line">#                               &quot;min_nodes_by_shard&quot;: [1],</div>
<div class="line">#                               &quot;max_nodes_by_shard&quot;: [1],</div>
<div class="line">#                               &quot;delivery_modes_by_shard&quot;: [&quot;Ordered&quot;],</div>
<div class="line">#                               &quot;profiles_by_shard&quot;: [&quot;DEFAULT&quot;]</div>
<div class="line">#                           },</div>
<div class="line">#                           {</div>
<div class="line">#                               &quot;min_nodes_by_shard&quot;: [1,3,5],</div>
<div class="line">#                               &quot;max_nodes_by_shard&quot;: [3,5,7],</div>
<div class="line">#                               &quot;delivery_modes_by_shard&quot;: [&quot;Ordered&quot;,&quot;Ordered&quot;,&quot;Raw&quot;],</div>
<div class="line">#                               &quot;profiles_by_shard&quot;: [&quot;VCS2_SHARD1&quot;,&quot;VCS2_SHARD2&quot;,&quot;VCS2_SHARD3&quot;]</div>
<div class="line">#                           }</div>
<div class="line">#                       ]</div>
<div class="line">#     },</div>
<div class="line">#     { ... },</div>
<div class="line">#     { ... },</div>
<div class="line">#     { ... }</div>
<div class="line">#</div>
<div class="line"># ]</div>
<div class="line"># &#39;</div>
<div class="line"># Please make sure a pair of single quotation marks &#39; are used around the json. GetPot formation enforced that for</div>
<div class="line"># multiline values.</div>
<div class="line">group_layout = </div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md47"></a>
To Run the Cascade Service Example</h1>
<p>___IMPORTANT: Please check if memory overcommitment kernel option is enabled in your linux kernel.___ </p><div class="fragment"><div class="line"># sysctl -n vm.overcommit_memory</div>
</div><!-- fragment --><p> ___If the result is 0, please enable it before running this example.___ </p><div class="fragment"><div class="line"># sysctl -w vm.overcommit_memory=1</div>
</div><!-- fragment --><p> ___Please note that Root privilege is required. And if you are running in a docker environment with out root privilege, you have to do this on the host kernel.___</p>
<p>Once cascade is built, you will find seven folders named <code>n0</code> to <code>n6</code> in <code>&lt;build_dir&gt;/src/service/cfg/</code>. Each of them contains a configuration file to run a demo service node with localhost IP and RDMA API layer over TCP/IP. In the folder, start the node by calling: </p><div class="fragment"><div class="line"># ../../cascade_server</div>
</div><!-- fragment --><p> Since the demo service requires six nodes to start running, let's start the server nodes in <code>n0</code>, <code>n1</code>, ..., <code>n5</code> and leave <code>n6</code> for the client by calling </p><div class="fragment"><div class="line"># ../../cascade_client</div>
</div><!-- fragment --><p> Once the client connnects to the service, it is going to show prompt for command. </p><div class="fragment"><div class="line">cmd&gt; help</div>
<div class="line">list_all_members</div>
<div class="line">        list all members in top level derecho group.</div>
<div class="line">list_type_members &lt;type&gt; [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        list members in shard by subgroup type.</div>
<div class="line">list_subgroup_members [subgroup_id(0)] [shard_index(0)]</div>
<div class="line">        list members in shard by subgroup id.</div>
<div class="line">set_member_selection_policy &lt;type&gt; &lt;subgroup_index&gt; &lt;shard_index&gt; &lt;policy&gt; [user_specified_node_id]</div>
<div class="line">        set member selection policy</div>
<div class="line">get_member_selection_policy &lt;type&gt; [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        get member selection policy</div>
<div class="line">put &lt;type&gt; &lt;key&gt; &lt;value&gt; [pver(-1)] [pver_by_key(-1)] [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        put an object</div>
<div class="line">remove &lt;type&gt; &lt;key&gt; [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        remove an object</div>
<div class="line">get &lt;type&gt; &lt;key&gt; [version(-1)] [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        get an object(by version)</div>
<div class="line">get_by_time &lt;type&gt; &lt;key&gt; &lt;ts_us&gt; [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        get an object by timestamp</div>
<div class="line">get_size &lt;type&gt; &lt;key&gt; [version(-1)] [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        get the size of an object(by version)</div>
<div class="line">get_size_by_time &lt;type&gt; &lt;key&gt; &lt;ts_us&gt; [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        get the size of an object by timestamp</div>
<div class="line">list_keys &lt;type&gt; [version(-1)] [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        list keys in shard (by version)</div>
<div class="line">list_keys_by_time &lt;type&gt; &lt;ts_us&gt; [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">        list keys in shard by time</div>
<div class="line">list_data_by_prefix &lt;type&gt; &lt;prefix&gt; [version(-1)] [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">         test LINQ api</div>
<div class="line">list_data_between_version &lt;type&gt; &lt;key&gt; &lt;subgroup_index&gt; &lt;shard_index&gt; [version_begin(MIN)] [version_end(MAX)]</div>
<div class="line">         test LINQ api - version_iterator</div>
<div class="line">list_data_of_key_between_timestamp &lt;type&gt; &lt;key&gt; [ts_begin(MIN)] [ts_end(MAX)] [subgroup_index(0)] [shard_index(0)]</div>
<div class="line">         test LINQ api - time_iterator</div>
<div class="line">list_data_in_subgroup &lt;type&gt; &lt;subgroup_index&gt; [version(-1)]</div>
<div class="line">         test LINQ api - subgroup_iterator</div>
<div class="line">quit|exit</div>
<div class="line">        exit the client.</div>
<div class="line">help</div>
<div class="line">        print this message.</div>
<div class="line"> </div>
<div class="line">type:=VCSU|VCSS|PCSU|PCSS</div>
<div class="line">policy:=FirstMember|LastMember|Random|FixedRandom|RoundRobin|UserSpecified</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">cmd&gt;</div>
</div><!-- fragment --><p> Then you can try process like this: </p><div class="fragment"><div class="line">cmd&gt; put VCSU 100 ABCDEFG</div>
<div class="line">cmd&gt; get VCSU 100</div>
<div class="line">node(0) replied with value:ObjectWithUInt64Key{ver: 0x1200000000, ts: 1599366091779929, id:100, data:[size:7, data: A B C D E F G]}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md48"></a>
The File System API</h1>
<p>We also provided a file system API to Cascade. The API is implemented as a libfuse driver talking to the service through an <code>external client</code>. Once mounted, the file system presents the data in the following structure: </p><div class="fragment"><div class="line">&lt;mount_point&gt;/&lt;subgroupType&gt;/subgroup_index/shard_index/Key</div>
</div><!-- fragment --><p> You can also check the ".cascade" file to get Cascade service properties like membership. Currently, the fuse file system is ReadOnly. We are working on adding time/version index and write supports to it.</p>
<p>To start the file system API, run <code>fuse_client</code> in n4: </p><div class="fragment"><div class="line"># mkdir fcc</div>
<div class="line"># ../../cascade_fuse_client -s -f fcc </div>
</div><!-- fragment --><p> Then, the file system api will mount on <code>fcc</code> folder. </p><div class="fragment"><div class="line"># ls fcc</div>
<div class="line">PCSS  PCSU  VCSS  VCSU</div>
<div class="line"># cat fcc/.cascade</div>
<div class="line">number of nodes in cascade service: 4.</div>
<div class="line">node IDs: 0,1,3,2,</div>
<div class="line"># cat fcc/VCSU/subgroup-0/shard-0/key100</div>
<div class="line">hdABCDEFG#</div>
</div><!-- fragment --><p> Please note that the file contents are deserialized byte array of the corresponding object.</p>
<h1><a class="anchor" id="autotoc_md49"></a>
Python API</h1>
<p>Python API document has moved to [here](python).</p>
<h1><a class="anchor" id="autotoc_md50"></a>
Java API</h1>
<p>Cascade service also supports data access using Java. Cascade cmake building script will detect the Java environment to decide whether to enable Java support. We suggest openjdk-14. For example, on Ubuntu, you can install it as follows: </p><div class="fragment"><div class="line"># sudo apt install openjdk-14-jdk</div>
</div><!-- fragment --><p> Once Java support is built, you should see <code>libcascade_jni.so</code> and <code>cascade.jar</code> in <code>&lt;build_path&gt;/src/service/java/</code>. <code>libcascade_jni.so</code> is the jni shared library; and <code>cascade.jar</code> is the API library for Java applications. You should also find <code>client_test.jar</code>, the Java version of <code>cascade_client</code>. To test, prepare the <code>derecho.cfg</code> in current work directory and try </p><div class="fragment"><div class="line">java -cp &quot;cascade.jar:client_test.jar&quot; io.cascade.test.ClientTest</div>
</div><!-- fragment --><p> Then it will show the same cli once connected to a server.</p>
<p>Sometimes, cmake cannot find Java native interface(JNI) headers and libraries automatically. It will complain that JNI is not found. You can set <code>JAVA_HOME</code> environment to tell cmake the location of the JDK as follows (my java is installed in <code>/usr/lib/jvm/java-14-openjdk-amd64</code>): </p><div class="fragment"><div class="line">export JAVA_HOME=/usr/lib/jvm/java-14-openjdk-amd64</div>
</div><!-- fragment --><p>To use the Java API, you just add <code>cascade.jar</code> to your classpath and import <code>io.cascade.*;</code>. The API is defined in <code><a class="el" href="classio_1_1cascade_1_1Client.html">io.cascade.Client</a></code> mirroring the C++ <a href="../../include/cascade/service.hpp#L155"><code>ServiceClientAPI</code> interface</a>. Please refer to <a href="java/io/cascade/test/ClientTest.java"><code>ClientTest.java</code></a> as an example.</p>
<p>Please note that the Java API does not implement the LINQ support yet. We plan to add it later. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7
</small></address>
</body>
</html>
